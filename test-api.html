<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Serbisyo API Test - Phase 7 & 8</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; }
        h2 { color: #666; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .endpoint { background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        .method { display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: bold; margin-right: 10px; }
        .get { background: #28a745; color: white; }
        .post { background: #007bff; color: white; }
        .put { background: #ffc107; color: black; }
        .delete { background: #dc3545; color: white; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { background: #f0f0f0; padding: 15px; margin-top: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .token-section { background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ E-Serbisyo API Test - Phase 7 & Phase 8</h1>
    
    <div class="section token-section">
        <h3>üîë Authentication</h3>
        <input type="text" id="token" placeholder="Paste JWT Token here" style="width: 300px;">
        <button onclick="setup()">1. Setup Database</button>
        <button onclick="createSuperAdmin()">2. Create Super Admin</button>
        <button onclick="loginSuperAdmin()">3. Login as Super Admin</button>
    </div>

    <div class="section">
        <h2>üìÑ Phase 7: Document Generation & Cryptography</h2>
        
        <div class="endpoint">
            <span class="method post">POST</span> 
            <strong>Template Upload</strong> - Upload document template (PNG/JPG/PDF)<br>
            <small>POST /api/v1/admin/document-types/:id/template</small><br>
            <input type="number" id="docTypeId" placeholder="Document Type ID" value="1">
            <input type="file" id="templateFile" accept=".png,.jpg,.jpeg,.pdf">
            <button onclick="uploadTemplate()">Upload Template</button>
            <div id="result-template" class="result"></div>
        </div>

        <div class="endpoint">
            <span class="method get">GET</span> 
            <strong>Generate PDF</strong> - Generate document with QR code<br>
            <small>GET /api/v1/requests/:request_id/generate-pdf</small><br>
            <input type="number" id="requestId" placeholder="Request ID" value="1">
            <button onclick="generatePDF()">Generate PDF</button>
            <div id="result-pdf" class="result"></div>
        </div>

        <div class="endpoint">
            <span class="method get">GET</span> 
            <strong>Public QR Verification</strong> - Verify document authenticity<br>
            <small>GET /api/v1/public/verify/:qr_hash</small><br>
            <input type="text" id="qrHash" placeholder="QR Hash" value="test123">
            <button onclick="verifyQR()">Verify QR</button>
            <div id="result-verify" class="result"></div>
        </div>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è Phase 8: System Administration & Auditing</h2>
        
        <div class="endpoint">
            <span class="method post">POST</span> 
            <strong>Create Official Account</strong> - Create Secretary/Treasurer/Captain<br>
            <small>POST /api/v1/admin/officials</small><br>
            <input type="text" id="officialId" placeholder="Official ID" value="SEC-001">
            <input type="text" id="fullName" placeholder="Full Name" value="John Doe">
            <input type="email" id="officialEmail" placeholder="Email" value="john@brgy.gov.ph">
            <input type="text" id="officialUsername" placeholder="Username" value="johndoe">
            <input type="password" id="officialPassword" placeholder="Password" value="password123">
            <select id="officialRole">
                <option value="Secretary">Secretary</option>
                <option value="Treasurer">Treasurer</option>
                <option value="Captain">Captain</option>
            </select>
            <button onclick="createOfficial()">Create Official</button>
            <div id="result-official" class="result"></div>
        </div>

        <div class="endpoint">
            <span class="method put">PUT</span> 
            <strong>Update Official Status</strong> - Activate/Suspend official<br>
            <small>PUT /api/v1/admin/officials/:id/status</small><br>
            <input type="number" id="updateOfficialId" placeholder="Official ID" value="2">
            <select id="accountStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
                <option value="Suspended">Suspended</option>
            </select>
            <button onclick="updateOfficialStatus()">Update Status</button>
            <div id="result-status" class="result"></div>
        </div>

        <div class="endpoint">
            <span class="method get">GET</span> 
            <strong>View Audit Logs</strong> - Forensic dashboard<br>
            <small>GET /api/v1/admin/audit-logs</small><br>
            <input type="number" id="auditLimit" placeholder="Limit" value="100">
            <button onclick="viewAuditLogs()">View Logs</button>
            <div id="result-audit" class="result"></div>
        </div>

        <div class="endpoint">
            <span class="method get">GET</span> 
            <strong>View System Settings</strong> - All settings<br>
            <small>GET /api/v1/admin/settings</small><br>
            <button onclick="viewSettings()">View Settings</button>
            <div id="result-settings" class="result"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5000/api/v1';
        
        function getToken() {
            return document.getElementById('token').value;
        }

        async function apiRequest(method, endpoint, body = null, isFile = false) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = { method, headers };
            
            if (body && !isFile) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(BASE_URL + endpoint, options);
                if (isFile && body) {
                    // For file upload, use FormData
                    const formData = new FormData();
                    formData.append('file', body);
                    const fileOptions = {
                        method,
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    };
                    const fileResponse = await fetch(BASE_URL + endpoint, fileOptions);
                    const fileResult = await fileResponse.json();
                    return fileResult;
                }
                const result = await response.json();
                return result;
            } catch (error) {
                return { error: error.message };
            }
        }

        // Phase 0: Setup Functions
        async function setup() {
            const result = await apiRequest('POST', '/setup/database');
            document.getElementById('result-template').textContent = JSON.stringify(result, null, 2);
        }

        async function createSuperAdmin() {
            const result = await apiRequest('POST', '/setup/superadmin');
            document.getElementById('result-template').textContent = JSON.stringify(result, null, 2);
        }

        async function loginSuperAdmin() {
            const result = await apiRequest('POST', '/auth/login', {
                email_or_username: 'superadmin',
                password: 'SuperAdmin123'
            });
            if (result.token) {
                document.getElementById('token').value = result.token;
            }
            document.getElementById('result-template').textContent = JSON.stringify(result, null, 2);
        }

        // Phase 7: Document Generation
        async function uploadTemplate() {
            const docTypeId = document.getElementById('docTypeId').value;
            const fileInput = document.getElementById('templateFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('result-template').textContent = 'Please select a file';
                return;
            }

            const token = getToken();
            const formData = new FormData();
            formData.append('file', file);

            const headers = {};
            if (token) headers['Authorization'] = `Bearer ${token}`;

            try {
                const response = await fetch(`${BASE_URL}/admin/document-types/${docTypeId}/template`, {
                    method: 'POST',
                    headers,
                    body: formData
                });
                const result = await response.json();
                document.getElementById('result-template').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('result-template').textContent = { error: error.message };
            }
        }

        async function generatePDF() {
            const requestId = document.getElementById('requestId').value;
            const token = getToken();
            
            if (!token) {
                document.getElementById('result-pdf').textContent = 'Please login first to get token';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/requests/${requestId}/generate-pdf`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document_${requestId}.pdf`;
                    a.click();
                    document.getElementById('result-pdf').textContent = 'PDF downloaded successfully!';
                } else {
                    const result = await response.json();
                    document.getElementById('result-pdf').textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                document.getElementById('result-pdf').textContent = { error: error.message };
            }
        }

        async function verifyQR() {
            const qrHash = document.getElementById('qrHash').value;
            const result = await apiRequest('GET', `/public/verify/${qrHash}`);
            document.getElementById('result-verify').textContent = JSON.stringify(result, null, 2);
        }

        // Phase 8: Administration
        async function createOfficial() {
            const body = {
                official_id: document.getElementById('officialId').value,
                full_name: document.getElementById('fullName').value,
                email_official: document.getElementById('officialEmail').value,
                username: document.getElementById('officialUsername').value,
                password: document.getElementById('officialPassword').value,
                role: document.getElementById('officialRole').value
            };
            const result = await apiRequest('POST', '/admin/officials', body);
            document.getElementById('result-official').textContent = JSON.stringify(result, null, 2);
        }

        async function updateOfficialStatus() {
            const id = document.getElementById('updateOfficialId').value;
            const status = document.getElementById('accountStatus').value;
            const result = await apiRequest('PUT', `/admin/officials/${id}/status`, { account_status: status });
            document.getElementById('result-status').textContent = JSON.stringify(result, null, 2);
        }

        async function viewAuditLogs() {
            const limit = document.getElementById('auditLimit').value;
            const result = await apiRequest('GET', `/admin/audit-logs?limit=${limit}`);
            document.getElementById('result-audit').textContent = JSON.stringify(result, null, 2);
        }

        async function viewSettings() {
            const result = await apiRequest('GET', '/admin/settings');
            document.getElementById('result-settings').textContent = JSON.stringify(result, null, 2);
        }
    </script>
</body>
</html>
